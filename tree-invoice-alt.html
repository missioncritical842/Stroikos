<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Tree Invoice Alt v1.22 (Direct API)</title>

    <style>
      body {
        font-family: Sans-Serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 5px;
      }

      .logo {
        max-width: 100px;
      }

      .letterhead {
        display: flex;
        align-items: center;
        margin-bottom: 2em;
        justify-content: space-between;
      }

      .letterhead .logo {
        margin-right: 1em;
        font-size: 12pt;
        margin-top: 0.5em;
      }

      .letterhead-text {
        flex-grow: 1;
        text-align: center;
      }

      .company-name {
        font-family: sans-serif;
        font-weight: bold;
        font-size: 18pt;
        letter-spacing: 0.05em;
      }

      .company-details {
        font-family: sans-serif;
        font-weight: 300;
        font-size: 12pt;
        margin-top: 0.5em;
      }

      .invoice-meta {
        /* margin-top: 2em; */ /* Removed to fix alignment */
      }

      .address-title {
        font-weight: bold;
        font-size: 1.1em;
        margin-bottom: 0;
        text-transform: uppercase;
      }

      .meta {
        color: #666;
      }

      .header .title {
        font-size: 300%;
        font-weight: bold;
      }

      .header .meta {
        text-transform: uppercase;
      }

      .info .meta {
        text-transform: uppercase;
      }

      .info .meta::after {
        content: " :";
      }

      .supplier {
        color: #333;
        display: block;
      }

      .block {
        padding-left: 5px;
        display: block;
      }

      .client, .items {
        padding: 1px;
        margin-top: 1em;
        margin-bottom: 1em;
        background: #ccc;
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
      }

      .client .title {
        margin-left: 4px;
        color: white;
        text-transform: uppercase;
      }

      .client .details {
        padding: 4px;
        background-color: var(--grist-theme-page-panels-main-panel-bg, white);
      }

      table.items {
        width: 100%;
        border: 1px solid #ccc;
        border-collapse: collapse;
      }

      table.items th {
        text-align: left;
        color: black;
        text-transform: uppercase;
        font-weight: normal;
        padding: 4px;
      }

      table.items td {
        background-color: var(--grist-theme-page-panels-main-panel-bg, white);
        padding: 4px;
        border: 1px solid #eee;
      }

      .client .title, table.items th, .help .title {
        padding-top: 10px;
        padding-bottom: 10px;
      }

      .money, .number {
        text-align: right;
        width: 15%;
        color: #333;
      }

      .name {
        color: #333;
      }

      .address {
        padding-bottom: 1em;
      }

      div.date-tag {
        display: inline-block;
        min-width: 80px;
      }

      div.top {
        display: flex;
        width: 100%;
        padding: 0px;
        justify-content: space-between;
      }

      div.instructions, .newlined, p.note {
        white-space: pre-line;
      }

      div.paid {
        position: relative;
        left: 40%;
        color: red;
        rotate: 15deg;
        font-size: 80px;
        top: 20px;
        border: 5px solid red;
        float: left;
        font-weight: bolder;
      }

      .app {
        position: relative;
      }

      /* Print styles for letter size paper */
      @media print {
        @page {
          size: letter;
          margin: 0.5in;
        }

        body {
          background: #e0e0e0 !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        .invoice-content {
          background: white !important;
          box-shadow: none !important;
          margin: 0 !important;
          width: 100% !important;
          min-height: auto !important;
        }

        .invoice-page {
          page-break-after: always;
          box-shadow: none !important;
          margin-bottom: 0 !important;
        }

        .invoice-page:last-child {
          page-break-after: avoid;
        }

        div.print,
        .control-panels {
          display: none !important;
        }
      }

      /* Screen styles for grey background preview */
      body {
        background: #e0e0e0;
      }

      /* Letter size page simulation: 8.5in x 11in with 0.5in margins = 7.5in x 10in content */
      .invoice-content {
        background: white;
        width: 7.5in;
        min-height: 10in;
        margin: 1em auto;
        padding: 0.5in;
        box-sizing: border-box;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      }

      /* For multi-page invoices */
      .invoice-page {
        background: white;
        width: 7.5in;
        min-height: 10in;
        margin: 1em auto;
        padding: 0.5in;
        box-sizing: border-box;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      }

      /* Control panels - won't print */
      .control-panels {
        max-width: 7.5in;
        margin: 0 auto 1em auto;
      }

      .selector-panel,
      .editor-panel {
        color: white;
        padding: 1em;
        border-radius: 4px;
        margin-bottom: 0.5em;
      }

      .selector-panel {
        background: #333;
      }

      .editor-panel {
        background: #1a5a1a;
      }

      .panel-title {
        font-size: 0.8em;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 0.75em;
        color: #aaa;
        border-bottom: 1px solid #555;
        padding-bottom: 0.5em;
      }

      .editor-panel .panel-title {
        color: #8f8;
        border-bottom-color: #3a7a3a;
      }

      .selector-panel label,
      .editor-panel label {
        display: block;
        margin-bottom: 0.25em;
        font-size: 0.9em;
        color: #ccc;
      }

      .selector-panel select,
      .editor-panel select {
        padding: 0.5em;
        font-size: 1em;
        min-width: 200px;
        margin-right: 1em;
        margin-bottom: 0.5em;
        border: none;
        border-radius: 4px;
      }

      .selector-row {
        display: flex;
        flex-wrap: wrap;
        gap: 1em;
        align-items: flex-end;
      }

      .selector-group {
        display: flex;
        flex-direction: column;
      }

      .create-btn {
        background: #2a7a2a;
        color: white;
        border: none;
        padding: 0.5em 1em;
        font-size: 1em;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 1.4em;
      }

      .create-btn:hover {
        background: #3a9a3a;
      }

      .create-btn:disabled {
        background: #666;
        cursor: not-allowed;
      }

      .add-item-btn {
        background: #4a4;
        color: white;
        border: none;
        padding: 0.5em 1em;
        font-size: 0.9em;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 0.5em;
      }

      .add-item-btn:hover {
        background: #5b5;
      }

      .save-btn {
        background: #2563eb;
        color: white;
        border: none;
        padding: 0.5em 1.5em;
        font-size: 1em;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
      }

      .save-btn:hover {
        background: #1d4ed8;
      }

      .save-btn:disabled {
        background: #666;
        cursor: not-allowed;
      }

      .unsaved-indicator {
        background: #f59e0b;
        color: white;
        padding: 0.25em 0.75em;
        border-radius: 4px;
        font-size: 0.85em;
        font-weight: bold;
      }

      /* Editor form styles */
      .editor-section {
        margin-top: 1em;
        padding-top: 1em;
        border-top: 1px solid #3a7a3a;
      }

      .editor-section-title {
        font-size: 0.75em;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: #8f8;
        margin-bottom: 0.5em;
      }

      .editor-row {
        display: flex;
        flex-wrap: wrap;
        gap: 1em;
        margin-bottom: 0.5em;
      }

      .editor-field {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-width: 150px;
      }

      .editor-field.small {
        flex: 0 0 100px;
        min-width: 100px;
      }

      .editor-field.wide {
        flex: 2;
        min-width: 300px;
      }

      .editor-field label {
        font-size: 0.8em;
        color: #aaa;
        margin-bottom: 0.25em;
      }

      .editor-field input,
      .editor-field textarea {
        padding: 0.5em;
        border: none;
        border-radius: 4px;
        font-size: 0.9em;
        font-family: inherit;
      }

      .editor-field textarea {
        min-height: 60px;
        resize: vertical;
      }

      .editor-field input[type="checkbox"] {
        width: 20px;
        height: 20px;
      }

      .editor-field.checkbox {
        flex-direction: row;
        align-items: center;
        gap: 0.5em;
        min-width: auto;
        flex: 0 0 auto;
      }

      .editor-field.checkbox label {
        margin-bottom: 0;
      }

      /* Tree items editor */
      .tree-item-editor {
        background: #2a6a2a;
        padding: 0.75em;
        border-radius: 4px;
        margin-bottom: 0.5em;
      }

      .tree-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5em;
      }

      .tree-item-number {
        font-size: 0.8em;
        color: #8f8;
      }

      .save-status {
        font-size: 0.8em;
        padding: 0.25em 0.5em;
        border-radius: 3px;
        margin-left: 1em;
      }

      .save-status.saving {
        background: #ff9;
        color: #333;
      }

      .save-status.saved {
        background: #4a4;
        color: white;
      }

      .save-status.error {
        background: #a44;
        color: white;
      }

      /* Editable invoice styles - inline editing that looks like the invoice */
      .editable-invoice {
        background: white;
        width: 7.5in;
        min-height: 10in;
        margin: 1em auto;
        padding: 0.5in;
        box-sizing: border-box;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      }

      .editable-invoice .edit-input,
      .editable-invoice .edit-textarea {
        background: #fffef0;
        border: 1px dashed #ccc;
        border-radius: 2px;
        padding: 2px 4px;
        font-family: inherit;
        font-size: inherit;
        color: inherit;
        box-sizing: border-box;
      }

      .editable-invoice .edit-input:focus,
      .editable-invoice .edit-textarea:focus {
        outline: none;
        border-color: #4a4;
        background: #fffff0;
      }

      .editable-invoice .edit-textarea {
        width: 100%;
        min-height: 1.5em;
        resize: none;
        overflow: hidden;
        line-height: 1.4;
      }

      .editable-invoice .edit-input.short {
        width: 80px;
      }

      .editable-invoice .edit-input.medium {
        width: 120px;
      }

      .editable-invoice .edit-input.date {
        width: 140px;
      }

      .editable-invoice .edit-input.number {
        width: 100px;
        text-align: right;
      }

      .editable-invoice .edit-inline {
        display: inline-block;
      }

      .editable-invoice .edit-row {
        display: flex;
        align-items: center;
        gap: 0.5em;
        margin-bottom: 0.25em;
      }

      .editable-invoice .edit-label {
        font-size: 0.75em;
        color: #888;
        text-transform: uppercase;
      }

      .editable-invoice .checkbox-field {
        display: flex;
        align-items: center;
        gap: 0.5em;
        margin: 0.5em 0;
      }

      .editable-invoice .checkbox-field input[type="checkbox"] {
        width: 18px;
        height: 18px;
      }

      .editable-invoice .checkbox-field label {
        font-size: 0.9em;
        color: #666;
      }

      /* Editable items table */
      .editable-invoice table.items .edit-input,
      .editable-invoice table.items .edit-textarea {
        margin: 0;
      }

      .editable-invoice table.items .edit-textarea {
        min-height: 2.5em;
      }

      .editable-invoice table.items td {
        vertical-align: top;
      }

      /* Notes section styling */
      .editable-invoice .notes-section {
        margin: 2em 0;
      }

      .editable-invoice .note-label {
        font-size: 0.75em;
        color: #888;
        text-transform: uppercase;
        margin-bottom: 0.25em;
      }

      /* Edit mode indicator */
      .edit-mode-bar {
        background: #1a5a1a;
        color: white;
        padding: 0.5em 1em;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 4px 4px 0 0;
        margin-top: 1em;
        max-width: 7.5in;
        margin-left: auto;
        margin-right: auto;
        box-sizing: border-box;
      }

      .edit-mode-bar .mode-label {
        font-weight: bold;
        text-transform: uppercase;
        font-size: 0.9em;
      }

      .editable-invoice {
        border-radius: 0 0 4px 4px;
        margin-top: 0;
      }

      @media print {
        .edit-mode-bar {
          display: none !important;
        }
        .editable-invoice {
          border-radius: 0;
        }
        .editable-invoice .edit-input,
        .editable-invoice .edit-textarea {
          background: transparent !important;
          border: none !important;
          padding: 0 !important;
        }
        .editable-invoice .edit-label,
        .editable-invoice .note-label,
        .editable-invoice .checkbox-field {
          display: none !important;
        }
      }

      div.print {
        position: fixed;
        left: 0;
        bottom: 0;
      }

      div.print a {
        background: #C83200;
        display: block;
        font-size: 200%;
        color: white;
        text-decoration: none;
        padding: 0.25em;
        padding-top: 0.5em;
        padding-right: 0.5em;
        border-top-right-radius: 0.5em;
        text-transform: uppercase;
      }

      div.print a:hover {
        background: #666;
      }

      .done {
        text-decoration: line-through;
      }

      div.column-name {
        display: inline-block;
      }

      .column-name {
        background: #666;
        color: white;
        margin: 2px;
        padding: 2px;
        border-radius: 2px;
        font-style: normal;
      }

      .column-recognized {
        background: green;
      }

      .column-expected {
        background: #666;
      }

      .column-ignored {
        background: red;
      }

      .help {
        padding: 1px;
        margin-top: 1em;
        margin-bottom: 1em;
        background: black;
        color: white;
      }

      .help .details {
        padding: 4px;
      }

      .help table {
        border: none;
      }

      .help td.key {
        text-align: right;
      }

      .help table {
        padding-bottom: 3px;
      }

      .help-close {
        display: float;
        float: right;
        max-width: 150px;
        padding: 5px;
        border-left: 1px solid white;
        border-bottom-left-radius: 5px;
        font-size: 80%;
        font-style: italic;
      }

      .help pre {
        display: inline-block;
        background: #ddd;
        color: #000;
        padding: 0.25em;
        margin-left: 1em;
      }

      .help .title {
        margin-left: 4px;
        text-transform: uppercase;
      }

      .status {
        padding: 4px;
      }

      .status .button {
        display: inline-block;
        text-decoration: none;
        color: #333;
        background: #ddd;
        padding-left: 0.5em;
        padding-right: 0.5em;
        padding-top: 1px;
        padding-bottom: 1px;
        margin-top: 1px;
        margin-bottom: 1px;
        border-radius: 0.25em;
      }

      table.items .total-row td {
        font-weight: bold;
        border-top: 2px solid #333;
      }

      .total-label {
        text-align: right;
        padding-right: 1em;
      }

      .currency-cell {
        display: flex;
        justify-content: space-between;
      }

      .money span {
        display: flex;
        justify-content: space-between;
      }

      .currency-symbol {
        margin-left: 4em;
      }

      .stump-man-header {
        font-family: sans-serif;
        font-weight: bold;
        text-transform: uppercase;
        font-size: 24pt;
      }

      .stump-man-container {
        position: relative;
        text-align: center;
        margin-bottom: 2em;
        height: 90px;
      }

      .stump-man-logo {
        max-height: 90px;
        position: absolute;
        right: 0;
        top: 0;
      }

      .footer-container {
        margin-top: 4em;
        position: relative;
        height: 60px;
      }

      .footer-email {
        text-align: center;
      }

      .footer-logo {
        position: absolute;
        right: 0;
        bottom: 0;
        max-height: 50px;
        max-width: 150px;
      }
    </style>

    <!-- A template for showing an invoice in a Custom Widget in Grist. -->
    <!-- Uses Vue.js, moment, and the Grist Plugin API -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.3/vue.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.27.0/moment.min.js"></script>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>

    <script>
    // ===========================================
    // Tree Invoice Alt - Direct API Fetching
    // ===========================================
    // This version fetches data directly from multiple Grist tables
    // instead of relying on a References column with expanded refs.
    //
    // Tables used:
    //   - Invoices2: Main invoice/quote records
    //   - Clients: Customer information
    //   - Invoicer: Business entity info
    //   - Trees: Line items (filtered by Trees.Invoice = invoice.id)
    // ===========================================

    function ready(fn) {
      if (document.readyState !== 'loading'){
        fn();
      } else {
        document.addEventListener('DOMContentLoaded', fn);
      }
    }

    // Cache for fetched tables
    const tableCache = {
      Clients: null,
      Invoicer: null,
      Invoices2: null,
      Trees: null
    };

    // Parse Grist's encoded list format: ["L", ["O", {...}], ["O", {...}]]
    function parseGristList(value) {
      if (!value) return [];
      if (Array.isArray(value)) {
        if (value[0] === 'L') {
          // Grist list format: ["L", item1, item2, ...]
          return value.slice(1).map(item => parseGristValue(item));
        }
        // Already a plain array
        return value;
      }
      return [];
    }

    // Parse Grist's encoded object format: ["O", {...}]
    function parseGristValue(value) {
      if (!value) return value;
      if (Array.isArray(value)) {
        if (value[0] === 'O' && value.length === 2) {
          // Grist object format: ["O", {actual object}]
          return value[1];
        }
        if (value[0] === 'L') {
          return parseGristList(value);
        }
        if (value[0] === 'd' && value.length === 2) {
          // Grist date format: ["d", timestamp]
          return value[1];
        }
      }
      return value;
    }

    // Convert Grist columnar table format to array of row objects
    function tableToRows(table) {
      if (!table || !table.id) return [];
      const rows = [];
      const columns = Object.keys(table);
      const numRows = table.id.length;

      for (let i = 0; i < numRows; i++) {
        const row = {};
        for (const col of columns) {
          row[col] = table[col][i];
        }
        rows.push(row);
      }
      return rows;
    }

    // Find a record by ID in a rows array
    function findById(rows, id) {
      return rows.find(r => r.id === id) || null;
    }

    // Fetch all required tables from Grist API
    async function fetchAllTables() {
      try {
        const [clientsTable, invoicerTable, invoicesTable, treesTable] = await Promise.all([
          grist.docApi.fetchTable('Clients'),
          grist.docApi.fetchTable('Invoicer'),
          grist.docApi.fetchTable('Invoices2'),
          grist.docApi.fetchTable('Trees')
        ]);

        tableCache.Clients = tableToRows(clientsTable);
        tableCache.Invoicer = tableToRows(invoicerTable);
        tableCache.Invoices2 = tableToRows(invoicesTable);
        tableCache.Trees = tableToRows(treesTable);

        console.log('Tables fetched:', {
          Clients: tableCache.Clients.length,
          Invoicer: tableCache.Invoicer.length,
          Invoices2: tableCache.Invoices2.length,
          Trees: tableCache.Trees.length
        });

        return true;
      } catch (err) {
        console.error('Error fetching tables:', err);
        throw new Error('Failed to fetch tables: ' + err.message);
      }
    }

    // Get all tree items for a specific invoice
    function getTreesForInvoice(invoiceId) {
      if (!tableCache.Trees) return [];
      return tableCache.Trees.filter(tree => tree.Invoice === invoiceId);
    }

    // Build complete invoice object from raw row and cached tables
    function buildInvoiceFromRow(row) {
      // Get the invoice row from cache if we only have an ID
      let invoiceRow = row;
      if (typeof row === 'number') {
        invoiceRow = findById(tableCache.Invoices2, row);
        if (!invoiceRow) {
          throw new Error('Invoice not found with ID: ' + row);
        }
      }

      // Look up Client by reference ID
      const clientId = invoiceRow.Client;
      const clientRow = clientId ? findById(tableCache.Clients, clientId) : null;

      // Look up Invoicer by reference ID
      const invoicerId = invoiceRow.Invoicer;
      const invoicerRow = invoicerId ? findById(tableCache.Invoicer, invoicerId) : null;

      // Get items directly from Trees table (filtered by invoice ID)
      const items = getTreesForInvoice(invoiceRow.id);

      // Build the complete invoice object
      const invoice = {
        id: invoiceRow.id,
        Number: invoiceRow.Number,
        Issued: invoiceRow.Issued,
        Due: invoiceRow.Due,
        Quote_Date: invoiceRow.Quote_Date,
        QuoteNote: invoiceRow.QuoteNote,
        InvoiceNote: invoiceRow.InvoiceNote,
        FinalQuoteText: invoiceRow.FinalQuoteText,
        FinalInvoiceText: invoiceRow.FinalInvoiceText,
        Invoice: invoiceRow.Invoice,
        Total: invoiceRow.Total,
        Paid: invoiceRow.Paid,

        // Nested Client object
        Client: clientRow ? {
          id: clientRow.id,
          First: clientRow.First,
          Last: clientRow.Last,
          Street1: clientRow.Street1,
          Street2: clientRow.Street2,
          City: clientRow.City,
          State: clientRow.State,
          Zip: clientRow.Zip,
          Email: clientRow.Email,
          Phone: clientRow.Phone
        } : null,

        // Nested Invoicer object
        Invoicer: invoicerRow ? {
          id: invoicerRow.id,
          Name: invoicerRow.Name,
          First: invoicerRow.First,
          Last: invoicerRow.Last,
          Street1: invoicerRow.Street1,
          Street2: invoicerRow.Street2,
          City: invoicerRow.City,
          State: invoicerRow.State,
          Zip: invoicerRow.Zip,
          Email: invoicerRow.Email,
          Phone: invoicerRow.Phone,
          Website: invoicerRow.Website
        } : null,

        // Parsed Items array
        Items: items
      };

      // Add Website URL if present
      if (invoice.Invoicer && invoice.Invoicer.Website) {
        invoice.Invoicer.Url = tweakUrl(invoice.Invoicer.Website);
      }

      return invoice;
    }

    const data = {
      count: 0,
      invoice: '',
      status: 'waiting',
      tableConnected: false,
      rowConnected: false,
      haveRows: false,
      tablesLoaded: false,
      // Selector state
      selectedInvoicerId: null,
      selectedClientId: null,
      selectedInvoiceId: null,
      invoicers: [],
      clients: [],
      invoicesForClient: [],
      // Editor state
      editMode: 'preview',
      saveStatus: '',
      treeSaveStatus: {},
      // Flag to prevent auto-refresh while we're making changes
      suppressRefresh: false,
      // Pending changes (for manual save)
      pendingInvoiceChanges: {},
      pendingTreeChanges: {},  // { treeId: { field: value, ... }, ... }
      hasUnsavedChanges: false
    };
    let app = undefined;

    Vue.filter('currency', formatNumberAsUSD)
    function formatNumberAsUSD(value) {
      if (typeof value !== "number") {
        return value || '—';
      }
      value = Math.round(value * 100) / 100;
      value = (value === -0 ? 0 : value);

      const result = value.toLocaleString('en', {
        style: 'currency', currency: 'USD'
      })
      if (result.includes('NaN')) {
        return value;
      }
      return result;
    }

    Vue.filter('fallback', function(value, str) {
      if (!value) {
        throw new Error("Please provide column " + str);
      }
      return value;
    });

    Vue.filter('asDate', function(value) {
      if (typeof(value) === 'number') {
        value = new Date(value * 1000);
      }
      const date = moment.utc(value)
      return date.isValid() ? date.format('MMMM DD, YYYY') : value;
    });

    function tweakUrl(url) {
      if (!url) { return url; }
      if (url.toLowerCase().startsWith('http')) {
        return url;
      }
      return 'https://' + url;
    };

    function handleError(err) {
      console.error(err);
      const target = app || data;
      target.invoice = '';
      target.status = String(err).replace(/^Error: /, '');
      console.log(data);
    }

    async function updateInvoice(row) {
      try {
        data.status = '';
        if (row === null) {
          throw new Error("(No data - not on row - please add or select a row)");
        }

        console.log("Received row:", row);

        // Fetch tables if not already loaded
        if (!data.tablesLoaded) {
          data.status = 'Loading tables...';
          await fetchAllTables();
          data.tablesLoaded = true;
        }

        // Build complete invoice from row ID and cached tables
        const invoice = buildInvoiceFromRow(row.id || row);

        console.log("Built invoice:", invoice);

        // Update Vue data
        data.invoice = invoice;
        data.status = '';

        // Make invoice available for debugging
        window.invoice = invoice;
      } catch (err) {
        handleError(err);
      }
    }

    // Populate the invoicer selector with Name-First format (all invoicers)
    function populateInvoicerSelector() {
      if (!tableCache.Invoicer) return;

      // Show all invoicers, sorted by name
      const allInvoicers = tableCache.Invoicer
        .map(i => ({
          id: i.id,
          name: [i.Name, i.First].filter(Boolean).join('-') || `Invoicer #${i.id}`
        }))
        .sort((a, b) => a.name.localeCompare(b.name));

      data.invoicers = allInvoicers;
    }

    // Populate client selector with all clients
    function populateClientSelector() {
      if (!tableCache.Clients) return;

      // Show all clients, sorted by name
      const allClients = tableCache.Clients
        .map(c => ({
          id: c.id,
          name: [c.First, c.Last].filter(Boolean).join(' ') || `Client #${c.id}`
        }))
        .sort((a, b) => a.name.localeCompare(b.name));

      data.clients = allClients;
    }

    // Update invoice list when client is selected
    function onClientSelected(clientId) {
      data.selectedClientId = clientId;
      data.selectedInvoiceId = null;
      data.selectedInvoicerId = null;
      data.invoice = '';
      data.invoicesForClient = [];

      if (!clientId) {
        return;
      }

      // Filter invoices for this client, sorted by number descending
      const invoices = tableCache.Invoices2
        .filter(inv => inv.Client === clientId)
        .map(inv => ({
          id: inv.id,
          number: inv.Number,
          isInvoice: inv.Invoice,
          label: `${inv.Invoice ? 'Invoice' : 'Quote'} #${inv.Number}`
        }))
        .sort((a, b) => b.number - a.number);

      data.invoicesForClient = invoices;
    }

    // Queue an invoice field change (doesn't save immediately)
    function queueInvoiceChange(field, value) {
      if (!data.invoice || !data.invoice.id) return;

      // Convert date strings to timestamps if needed
      if (['Issued', 'Due', 'Quote_Date'].includes(field) && value) {
        const date = new Date(value);
        if (!isNaN(date.getTime())) {
          value = Math.floor(date.getTime() / 1000);
        }
      }

      Vue.set(data.pendingInvoiceChanges, field, value);
      data.hasUnsavedChanges = true;

      // Update the displayed invoice locally (without saving)
      if (data.invoice) {
        Vue.set(data.invoice, field, value);
      }
    }

    // Queue a tree field change (doesn't save immediately)
    function queueTreeChange(treeId, field, value) {
      if (!treeId) return;

      if (!data.pendingTreeChanges[treeId]) {
        Vue.set(data.pendingTreeChanges, treeId, {});
      }
      Vue.set(data.pendingTreeChanges[treeId], field, value);
      data.hasUnsavedChanges = true;

      // Update the displayed item locally (without saving)
      if (data.invoice && data.invoice.Items) {
        const item = data.invoice.Items.find(i => i.id === treeId);
        if (item) {
          Vue.set(item, field, value);
        }
      }
    }

    // Save all pending changes
    async function saveAllChanges() {
      if (!data.hasUnsavedChanges) return;

      try {
        data.saveStatus = 'saving';
        data.suppressRefresh = true;

        const actions = [];

        // Queue invoice changes
        if (Object.keys(data.pendingInvoiceChanges).length > 0) {
          actions.push(['UpdateRecord', 'Invoices2', data.invoice.id, { ...data.pendingInvoiceChanges }]);
        }

        // Queue tree changes
        for (const [treeId, changes] of Object.entries(data.pendingTreeChanges)) {
          if (Object.keys(changes).length > 0) {
            actions.push(['UpdateRecord', 'Trees', parseInt(treeId), { ...changes }]);
          }
        }

        if (actions.length > 0) {
          console.log('Saving actions:', actions);
          await grist.docApi.applyUserActions(actions);
        }

        // Clear pending changes
        data.pendingInvoiceChanges = {};
        data.pendingTreeChanges = {};
        data.hasUnsavedChanges = false;

        // Refresh tables to get recalculated formula values (like Total)
        const savedInvoiceId = data.invoice.id;
        const [invoicesTable, treesTable] = await Promise.all([
          grist.docApi.fetchTable('Invoices2'),
          grist.docApi.fetchTable('Trees')
        ]);
        tableCache.Invoices2 = tableToRows(invoicesTable);
        tableCache.Trees = tableToRows(treesTable);

        // Rebuild the invoice with fresh data
        const invoice = buildInvoiceFromRow(savedInvoiceId);
        data.invoice = invoice;
        window.invoice = invoice;

        data.saveStatus = 'saved';
        setTimeout(() => {
          if (data.saveStatus === 'saved') data.saveStatus = '';
          data.suppressRefresh = false;
        }, 2000);
      } catch (err) {
        console.error('Failed to save changes:', err);
        alert('Failed to save: ' + err.message);
        data.saveStatus = 'error';
        data.suppressRefresh = false;
      }
    }

    // Create a new tree/line item for the current invoice
    async function createNewTreeItem() {
      if (!data.invoice || !data.invoice.id) {
        console.warn('No invoice selected');
        alert('Please select an invoice first');
        return;
      }

      try {
        data.saveStatus = 'saving';
        data.suppressRefresh = true;

        console.log('Creating new tree item for invoice:', data.invoice.id);

        // Create new tree record linked to this invoice
        // Note: Total is a formula column, don't try to set it
        await grist.docApi.applyUserActions([
          ['AddRecord', 'Trees', null, {
            Invoice: data.invoice.id,
            Description: 'New item - click to edit',
            Price: 0,
            Quantity: 1
          }]
        ]);

        console.log('Tree item created, refreshing...');

        // Refresh the trees cache
        const treesTable = await grist.docApi.fetchTable('Trees');
        tableCache.Trees = tableToRows(treesTable);

        // Rebuild the invoice to include the new item
        const invoice = buildInvoiceFromRow(data.invoice.id);
        data.invoice = invoice;
        window.invoice = invoice;

        data.saveStatus = 'saved';
        setTimeout(() => {
          if (data.saveStatus === 'saved') data.saveStatus = '';
          data.suppressRefresh = false;
        }, 2000);
      } catch (err) {
        console.error('Failed to create tree item:', err);
        alert('Failed to create item: ' + err.message);
        data.saveStatus = 'error';
        data.suppressRefresh = false;
      }
    }

    // Create a new invoice for the selected client
    async function createNewInvoice() {
      if (!data.selectedClientId) {
        console.warn('No client selected');
        return;
      }

      try {
        data.status = 'Creating invoice...';
        data.suppressRefresh = true;

        // Create new invoice record with just the client reference
        // The Number field will be auto-generated by trigger formula ($id + 660)
        await grist.docApi.applyUserActions([
          ['AddRecord', 'Invoices2', null, {
            Client: data.selectedClientId,
            Invoice: false,  // Default to quote
            Issued: Math.floor(Date.now() / 1000)  // Today's date
          }]
        ]);

        console.log('Invoice created, refreshing tables...');

        // Refresh tables to get the new invoice
        await fetchAllTables();
        populateClientSelector();
        populateInvoicerSelector();

        // Re-filter invoices for this client
        const invoices = tableCache.Invoices2
          .filter(inv => inv.Client === data.selectedClientId)
          .map(inv => ({
            id: inv.id,
            number: inv.Number,
            isInvoice: inv.Invoice,
            label: `${inv.Invoice ? 'Invoice' : 'Quote'} #${inv.Number}`
          }))
          .sort((a, b) => b.number - a.number);
        data.invoicesForClient = invoices;

        // Select the newest invoice (first in sorted list, highest number)
        const newInvoiceId = invoices.length > 0 ? invoices[0].id : null;
        if (newInvoiceId) {
          data.selectedInvoiceId = newInvoiceId;
          const invoice = buildInvoiceFromRow(newInvoiceId);
          data.invoice = invoice;
          if (invoice.Invoicer && invoice.Invoicer.id) {
            data.selectedInvoicerId = invoice.Invoicer.id;
          }
          window.invoice = invoice;

          // Switch to edit mode
          data.editMode = 'edit';
        }

        data.status = '';
        data.suppressRefresh = false;
      } catch (err) {
        console.error('Failed to create invoice:', err);
        data.suppressRefresh = false;
        data.status = 'Failed to create invoice: ' + err.message;
      }
    }

    // Update the invoicer on the current invoice in Grist
    async function onInvoicerChanged(invoicerId) {
      if (!data.invoice || !data.invoice.id) {
        console.warn('No invoice selected to update');
        return;
      }

      data.selectedInvoicerId = invoicerId;

      if (!invoicerId) {
        return;
      }

      try {
        data.status = 'Updating invoicer...';

        // Update the invoice record in Grist
        await grist.docApi.applyUserActions([
          ['UpdateRecord', 'Invoices2', data.invoice.id, { Invoicer: invoicerId }]
        ]);

        // Update local cache
        const cachedInvoice = findById(tableCache.Invoices2, data.invoice.id);
        if (cachedInvoice) {
          cachedInvoice.Invoicer = invoicerId;
        }

        // Rebuild the invoice display with new invoicer
        const invoice = buildInvoiceFromRow(data.invoice.id);
        data.invoice = invoice;
        window.invoice = invoice;

        data.status = '';
        console.log('Invoicer updated to:', invoicerId);
      } catch (err) {
        console.error('Failed to update invoicer:', err);
        data.status = 'Failed to update invoicer: ' + err.message;
      }
    }

    // Load invoice when selected from dropdown
    function onInvoiceSelected(invoiceId) {
      data.selectedInvoiceId = invoiceId;
      data.selectedInvoicerId = null;

      if (!invoiceId) {
        data.invoice = '';
        return;
      }

      try {
        const invoice = buildInvoiceFromRow(parseInt(invoiceId));
        data.invoice = invoice;
        data.status = '';
        window.invoice = invoice;

        // Set the invoicer selector to the invoice's current invoicer
        if (invoice.Invoicer && invoice.Invoicer.id) {
          data.selectedInvoicerId = invoice.Invoicer.id;
        }
      } catch (err) {
        handleError(err);
      }
    }

    // Refresh tables and rebuild current invoice
    async function refreshTables() {
      try {
        data.status = 'Refreshing tables...';

        // Save current selections before refresh
        const savedClientId = data.selectedClientId;
        const savedInvoiceId = data.selectedInvoiceId;
        const savedInvoicerId = data.selectedInvoicerId;

        data.tablesLoaded = false;
        await fetchAllTables();
        data.tablesLoaded = true;

        // Populate selectors
        populateClientSelector();
        populateInvoicerSelector();

        // Restore selections
        data.selectedClientId = savedClientId;
        data.selectedInvoiceId = savedInvoiceId;
        data.selectedInvoicerId = savedInvoicerId;

        // Re-filter invoices for client (without clearing selections)
        if (savedClientId) {
          const invoices = tableCache.Invoices2
            .filter(inv => inv.Client === savedClientId)
            .map(inv => ({
              id: inv.id,
              number: inv.Number,
              isInvoice: inv.Invoice,
              label: `${inv.Invoice ? 'Invoice' : 'Quote'} #${inv.Number}`
            }))
            .sort((a, b) => b.number - a.number);
          data.invoicesForClient = invoices;
        }

        // Rebuild current invoice if we have one
        if (savedInvoiceId) {
          const invoice = buildInvoiceFromRow(savedInvoiceId);
          data.invoice = invoice;
          // Update invoicer selection to match invoice's current invoicer
          if (invoice.Invoicer && invoice.Invoicer.id) {
            data.selectedInvoicerId = invoice.Invoicer.id;
          }
        }

        data.status = '';
      } catch (err) {
        handleError(err);
      }
    }

    // Initial load of tables and selectors
    async function initializeTables() {
      try {
        data.status = 'Loading tables...';
        await fetchAllTables();
        data.tablesLoaded = true;
        populateClientSelector();
        populateInvoicerSelector();
        data.status = '';
      } catch (err) {
        handleError(err);
      }
    }

    ready(function() {
      grist.ready();

      // Initialize tables immediately
      initializeTables();

      // Listen for any data changes to refresh our cache
      grist.on('message', msg => {
        if (msg.tableId) {
          data.tableConnected = true;
          data.haveRows = true;
        }

        // Refresh tables when data changes (but not if we triggered the change)
        if (msg.dataChange && data.tablesLoaded && !data.suppressRefresh) {
          console.log('Data changed, refreshing tables...');
          refreshTables();
        }
      });

      Vue.config.errorHandler = function (err, vm, info) {
        handleError(err);
      };

      app = new Vue({
        el: '#app',
        data: data,
        methods: {
          onClientSelected: function(event) {
            onClientSelected(event.target.value ? parseInt(event.target.value) : null);
          },
          onInvoiceSelected: function(event) {
            onInvoiceSelected(event.target.value ? parseInt(event.target.value) : null);
          },
          onInvoicerChanged: function(event) {
            onInvoicerChanged(event.target.value ? parseInt(event.target.value) : null);
          },
          createNewInvoice: function() {
            createNewInvoice();
          },
          createNewTreeItem: function() {
            createNewTreeItem();
          },
          saveAllChanges: function() {
            saveAllChanges();
          },
          // Invoice field editors (queue changes, don't save immediately)
          updateInvoiceText: function(field, event) {
            queueInvoiceChange(field, event.target.value);
          },
          updateInvoiceNumber: function(field, event) {
            const value = parseFloat(event.target.value) || 0;
            queueInvoiceChange(field, value);
          },
          updateInvoiceCheckbox: function(field, event) {
            queueInvoiceChange(field, event.target.checked);
          },
          updateInvoiceDate: function(field, event) {
            queueInvoiceChange(field, event.target.value);
          },
          // Tree field editors (queue changes, don't save immediately)
          updateTreeText: function(treeId, field, event) {
            queueTreeChange(treeId, field, event.target.value);
          },
          updateTreeNumber: function(treeId, field, event) {
            const value = parseFloat(event.target.value) || 0;
            queueTreeChange(treeId, field, value);
          },
          // Helper to format date for input
          formatDateForInput: function(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp * 1000);
            if (isNaN(date.getTime())) return '';
            return date.toISOString().split('T')[0];
          },
          // Auto-resize textarea to fit content
          autoResize: function(event) {
            const el = event.target;
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
          },
          // Calculate total from items
          calculateTotal: function() {
            if (!this.invoice || !this.invoice.Items || !Array.isArray(this.invoice.Items)) {
              return 0;
            }
            return this.invoice.Items.reduce((sum, item) => sum + (Number(item.Total) || 0), 0);
          }
        }
      });
    });
    </script>
  </head>
  <body>
    <div id="app">
      <!-- Control Panels - won't print -->
      <div class="control-panels">
        <!-- Selector Panel -->
        <div class="selector-panel">
          <div class="panel-title">Select Invoice</div>
          <div class="selector-row">
            <div class="selector-group">
              <label>Client</label>
              <select @change="onClientSelected" :value="selectedClientId">
                <option value="">-- Select Client --</option>
                <option v-for="client in clients" :key="client.id" :value="client.id">
                  {{ client.name }}
                </option>
              </select>
            </div>
            <div class="selector-group">
              <label>Invoice/Quote</label>
              <select @change="onInvoiceSelected" :value="selectedInvoiceId" :disabled="!selectedClientId">
                <option value="">-- Select Invoice --</option>
                <option v-for="inv in invoicesForClient" :key="inv.id" :value="inv.id">
                  {{ inv.label }}
                </option>
              </select>
            </div>
            <button class="create-btn" @click="createNewInvoice" :disabled="!selectedClientId">
              + New Quote
            </button>
          </div>
        </div>

        <!-- Mode Toggle in Selector Panel -->
        <div class="editor-panel" v-if="selectedInvoiceId" style="padding: 0.5em 1em;">
          <div class="selector-row" style="justify-content: space-between;">
            <div class="selector-group">
              <label>View Mode</label>
              <select v-model="editMode">
                <option value="preview">Preview (Print Ready)</option>
                <option value="edit">Edit Invoice</option>
              </select>
            </div>
            <div style="display: flex; align-items: center; gap: 1em;">
              <span v-if="saveStatus" :class="['save-status', saveStatus]">
                {{ saveStatus === 'saving' ? 'Saving...' : saveStatus === 'saved' ? 'Saved' : 'Error' }}
              </span>
            </div>
          </div>
        </div>

        <div v-if="status && status !== 'waiting'" style="padding: 0.5em; color: #f99;">
          {{ status }}
        </div>
      </div>

      <template v-if="invoice">

      <!-- ==================== EDIT MODE ==================== -->
      <template v-if="editMode === 'edit'">
        <div class="edit-mode-bar">
          <span class="mode-label">Edit Mode</span>
          <div style="display: flex; align-items: center; gap: 1em;">
            <span v-if="hasUnsavedChanges" class="unsaved-indicator">Unsaved Changes</span>
            <span v-if="saveStatus" :class="['save-status', saveStatus]">
              {{ saveStatus === 'saving' ? 'Saving...' : saveStatus === 'saved' ? 'Saved' : 'Error' }}
            </span>
            <button class="save-btn" @click="saveAllChanges" :disabled="!hasUnsavedChanges || saveStatus === 'saving'">
              Save Changes
            </button>
          </div>
        </div>
        <div class="editable-invoice">
          <!-- Invoicer Selection -->
          <div style="margin-bottom: 1em; padding-bottom: 1em; border-bottom: 1px dashed #ccc;">
            <span class="edit-label">Invoicer:</span>
            <select @change="onInvoicerChanged" :value="selectedInvoicerId" style="padding: 0.25em; font-size: 1em;">
              <option value="">-- Select Invoicer --</option>
              <option v-for="invoicer in invoicers" :key="invoicer.id" :value="invoicer.id">
                {{ invoicer.name }}
              </option>
            </select>
          </div>

          <!-- Header (same as preview) -->
          <template v-if="invoice.Invoicer && invoice.Invoicer.Name === 'Stroikos Services'">
            <div class="letterhead">
              <img class="logo" src="https://stroikos.com/wp-content/uploads/2024/10/Stroikos-services-logo.png" alt="Stroikos Logo">
              <div class="letterhead-text">
                <div class="company-name">Stroikos Services — Tree Care</div>
                <div class="company-details">Arbores amamus</div>
              </div>
            </div>
          </template>
          <template v-else-if="invoice.Invoicer && invoice.Invoicer.Name === 'A Stump Man'">
            <div class="stump-man-container">
              <div class="stump-man-header">A STUMP MAN</div>
              <img class="stump-man-logo" src="https://stroikos.com/wp-content/uploads/2025/06/A-Stump-Man-Logo.jpg" alt="A Stump Man Logo">
            </div>
          </template>

          <!-- Client & Invoice Info -->
          <div class="top">
            <div class="supplier">
              <div class="address-title">Client</div>
              <div v-if="invoice.Client">
                <div class="address">
                  <span class="name">{{ invoice.Client.First }} {{ invoice.Client.Last }}</span><br />
                  {{ invoice.Client.Street1 }}<br />
                  <template v-if="invoice.Client.Street2">{{ invoice.Client.Street2 }}<br /></template>
                  {{ invoice.Client.City }} {{ invoice.Client.State }} {{ invoice.Client.Zip }}
                </div>
                <div class="invoice-meta" style="margin-top: 0.5em;">
                  <div class="edit-row">
                    <span class="edit-label">Type:</span>
                    <label style="margin-right: 1em;"><input type="checkbox" :checked="invoice.Invoice" @change="updateInvoiceCheckbox('Invoice', $event)"> Invoice</label>
                    <label><input type="checkbox" :checked="invoice.Paid" @change="updateInvoiceCheckbox('Paid', $event)"> Paid</label>
                  </div>
                  <div class="edit-row">
                    <span class="edit-label">{{ invoice.Invoice ? 'Invoice' : 'Quote' }} #:</span>
                    <strong>{{ invoice.Number }}</strong>
                  </div>
                  <div class="edit-row">
                    <span class="edit-label">{{ invoice.Invoice ? 'Issued' : 'Quote Date' }}:</span>
                    <input type="date" class="edit-input date" :value="formatDateForInput(invoice.Invoice ? invoice.Issued : invoice.Quote_Date)" @input="updateInvoiceDate(invoice.Invoice ? 'Issued' : 'Quote_Date', $event)">
                  </div>
                  <div class="edit-row" v-if="invoice.Invoice">
                    <span class="edit-label">Due:</span>
                    <input type="date" class="edit-input date" :value="formatDateForInput(invoice.Due)" @input="updateInvoiceDate('Due', $event)">
                  </div>
                </div>
              </div>
            </div>

            <template v-if="invoice.Invoicer && invoice.Invoicer.Name === 'Stroikos Services'">
              <div class="supplier">
                <div class="address-title">From</div>
                <div class="address">
                  <span class="name">{{ invoice.Invoicer.Name }}</span><br />
                  {{ invoice.Invoicer.Street1 }}<br />
                  <template v-if="invoice.Invoicer.Street2">{{ invoice.Invoicer.Street2 }}<br /></template>
                  {{ invoice.Invoicer.City }} {{ invoice.Invoicer.State }} {{ invoice.Invoicer.Zip }}
                </div>
              </div>
            </template>
          </div>

          <!-- Greeting & Note -->
          <div style="margin: 2em 0;">
            <p v-if="invoice.Client">
              Dear {{ invoice.Client.First }},
            </p>
            <div style="margin-top: 1em;">
              <div class="note-label">{{ invoice.Invoice ? 'Invoice' : 'Quote' }} Note:</div>
              <textarea class="edit-textarea" :value="invoice.Invoice ? invoice.InvoiceNote : invoice.QuoteNote" @input="updateInvoiceText(invoice.Invoice ? 'InvoiceNote' : 'QuoteNote', $event); autoResize($event)" @focus="autoResize($event)" placeholder="Add a note..."></textarea>
            </div>
          </div>

          <!-- Items Table -->
          <table class="items">
            <tr>
              <th>Description</th>
              <th class="money" style="width: 100px;">Price</th>
            </tr>
            <tr v-for="(item, index) in invoice.Items" :key="item.id">
              <td>
                <textarea class="edit-textarea" :value="item.Description" @input="updateTreeText(item.id, 'Description', $event); autoResize($event)" @focus="autoResize($event)" placeholder="Item description..."></textarea>
                <span v-if="treeSaveStatus[item.id]" :class="['save-status', treeSaveStatus[item.id]]" style="font-size: 0.75em;">
                  {{ treeSaveStatus[item.id] === 'saving' ? 'Saving...' : treeSaveStatus[item.id] === 'saved' ? '✓' : '!' }}
                </span>
              </td>
              <td class="money">
                <input type="number" class="edit-input number" :value="item.Price" @input="updateTreeNumber(item.id, 'Price', $event)">
              </td>
            </tr>
            <tr class="total-row">
              <td class="total-label">Total</td>
              <td class="money">
                <strong>${{ calculateTotal().toLocaleString('en-US') }}</strong>
              </td>
            </tr>
          </table>
          <button class="add-item-btn" @click="createNewTreeItem">+ Add Line Item</button>

          <!-- Final Text -->
          <div style="margin-top: 2em;">
            <div class="note-label">Final {{ invoice.Invoice ? 'Invoice' : 'Quote' }} Text:</div>
            <textarea class="edit-textarea" :value="invoice.Invoice ? invoice.FinalInvoiceText : invoice.FinalQuoteText" @input="updateInvoiceText(invoice.Invoice ? 'FinalInvoiceText' : 'FinalQuoteText', $event); autoResize($event)" @focus="autoResize($event)" placeholder="Closing text..."></textarea>
            <p style="margin-top: 1em;">Gratefully,</p>
            <br/>
            <p v-if="invoice.Invoicer && typeof invoice.Invoicer === 'object'">
              {{ invoice.Invoicer.First }} {{ invoice.Invoicer.Last }}
            </p>
            <div v-if="invoice.Invoicer && typeof invoice.Invoicer === 'object'">
              <div class="email">{{ invoice.Invoicer.Email }}</div>
              <div class="phone">{{ invoice.Invoicer.Phone }}</div>
              <div class="website" v-if="invoice.Invoicer.Website">{{ invoice.Invoicer.Website }}</div>
            </div>
          </div>

          <!-- Paid Stamp -->
          <template v-if="invoice.Paid">
            <div class="paid">PAID</div>
          </template>
        </div>
      </template>

      <!-- ==================== PREVIEW MODE ==================== -->
      <div class="invoice-content" v-else>
        <template v-if="invoice.Invoicer && invoice.Invoicer.Name === 'Stroikos Services'">
          <div class="letterhead">
            <img class="logo" src="https://stroikos.com/wp-content/uploads/2024/10/Stroikos-services-logo.png" alt="Stroikos Logo">
            <div class="letterhead-text">
              <div class="company-name">Stroikos Services — Tree Care</div>
              <div class="company-details">Arbores amamus</div>
            </div>
          </div>
        </template>
        <template v-else-if="invoice.Invoicer && invoice.Invoicer.Name === 'A Stump Man'">
          <div class="stump-man-container">
            <div class="stump-man-header">A STUMP MAN</div>
            <img class="stump-man-logo" src="https://stroikos.com/wp-content/uploads/2025/06/A-Stump-Man-Logo.jpg" alt="A Stump Man Logo">
          </div>
        </template>
        <div class="top">
          <div class="supplier">
            <div class="address-title">Client</div>
            <div v-for="business in (invoice.Client ? [invoice.Client] : [])">
              <template v-if="typeof(business) === 'string'">
                <div class="address newlined">{{ business }}</div>
              </template>
              <template v-else>
                <div class="address">
                  <span class="name">{{ business.First }} {{ business.Last }}</span><br />
                  {{ business.Street1 }}<br />
                  <template v-if="business.Street2">
                    {{ business.Street2 }}<br />
                  </template>
                  {{ business.City }} {{ business.State }} {{ business.Zip }}<br />
                  <template v-if="business.Country">
                    {{ business.Country }}<br />
                  </template>
                </div>
              </template>
              <div class="invoice-meta">
                <div v-if="invoice.Invoice ? invoice.Issued : invoice.Quote_Date"><strong>Date:</strong> {{ (invoice.Invoice ? invoice.Issued : invoice.Quote_Date) | asDate }}</div>
                <div v-if="invoice.Number"><strong>{{ invoice.Invoice ? 'Invoice' : 'Quote' }} #:</strong> {{ invoice.Number }}</div>
              </div>
            </div>
          </div>

          <template v-if="invoice.Invoicer && invoice.Invoicer.Name === 'Stroikos Services'">
            <div class="supplier">
              <div class="address-title">From</div>
              <div v-for="business in (invoice.Invoicer ? [invoice.Invoicer] : [])">
                <template v-if="typeof(business) === 'string'">
                  <div class="address newlined">{{ business }}</div>
                </template>
                <template v-else>
                  <div class="address">
                    <span class="name">{{ business.Name }}</span><br />
                    {{ business.Street1 }}<br />
                    <template v-if="business.Street2">
                      {{ business.Street2 }}<br />
                    </template>
                    {{ business.City }} {{ business.State }} {{ business.Zip }}<br />
                    <template v-if="business.Country">
                      {{ business.Country }}<br />
                    </template>
                  </div>
                </template>
                <div class="invoice-meta">
                  <div v-if="invoice.Invoice && invoice.Due">
                    <strong>Due Date:</strong> {{ invoice.Due | asDate }}
                  </div>
                </div>
              </div>
            </div>
          </template>
        </div>

        <div style="margin: 2em 0;">
          <p v-if="invoice.Client">
            Dear {{ typeof invoice.Client === 'object' ? invoice.Client.First : invoice.Client }},
          </p>
          <p v-if="invoice.Invoice ? invoice.InvoiceNote : invoice.QuoteNote" class="note" style="margin-top: 1em;">
            {{ invoice.Invoice ? invoice.InvoiceNote : invoice.QuoteNote }}
          </p>
        </div>

        <table class="items">
          <template v-if="!Array.isArray(invoice.Items)">
            <tr>
              <th>Description</th>
              <th class="money">Price</th>
            </tr>
            <tr>
              <td>{{ invoice.Items }}</td>
              <td class="money">{{ invoice.Total | currency }}</td>
            </tr>
          </template>
          <template v-else>
            <tr>
              <th>Description</th>
              <th class="money">Price</th>
            </tr>
            <tr v-for="(item, index) in invoice.Items">
              <td>{{ item.Description || [item.Task_Description_Start, [item.Tree_Kind, item.Task_Descriptions].filter(Boolean).join('')].filter(Boolean).join(' ') }}</td>
              <td class="money">
                <span>
                  <span :class="{ 'currency-symbol': index === 0 }">{{ index === 0 ? '$' : '' }}</span>
                  <span>{{ Math.round(Number(item.Total)).toLocaleString('en-US') }}</span>
                </span>
              </td>
            </tr>
            <tr class="total-row">
              <td class="total-label">Total</td>
              <td class="money">
                <span>
                  <span class="currency-symbol">$</span>
                  <span>{{ Math.round(Number(invoice.Total)).toLocaleString('en-US') }}</span>
                </span>
              </td>
            </tr>
          </template>
        </table>

        <div style="margin-top: 2em;">
          <p v-if="invoice.Invoice ? invoice.FinalInvoiceText : invoice.FinalQuoteText" class="note">
            <span>{{ invoice.Invoice ? invoice.FinalInvoiceText : invoice.FinalQuoteText }}</span>
            <span v-if="invoice.Invoicer"> {{ typeof invoice.Invoicer === 'object' ? invoice.Invoicer.Name : invoice.Invoicer }}.</span>
          </p>
          <p v-else-if="invoice.Invoicer">Thank you for considering {{ typeof invoice.Invoicer === 'object' ? invoice.Invoicer.Name : invoice.Invoicer }}.</p>
          <br/>
          <p style="margin-top: 1em;">Gratefully,</p>
          <br/><br/>
          <p v-if="invoice.Invoicer && typeof invoice.Invoicer === 'object'" style="margin-top: 1em; margin-bottom: 0;">
            {{ invoice.Invoicer.First }} {{ invoice.Invoicer.Last }}
          </p>
          <div v-if="invoice.Invoicer && typeof invoice.Invoicer === 'object'">
            <template v-if="invoice.Invoicer.Email">
              <div class="email">{{ invoice.Invoicer.Email }}</div>
            </template>
            <template v-if="invoice.Invoicer.Phone">
              <div class="phone">{{ invoice.Invoicer.Phone }}</div>
            </template>
            <template v-if="invoice.Invoicer.Website">
              <div class="website"><a v-bind:href="invoice.Invoicer.Url">{{ invoice.Invoicer.Website }}</a></div>
            </template>
          </div>
        </div>

        <!-- Direct API version - no References column needed -->
        <template v-if="invoice.Paid">
          <div class="paid">
            PAID
          </div>
        </template>

        <div class="print">
          <a href="javascript:window.print()">Print</a>
        </div>
      </div><!-- end invoice-content -->
      </template>
    </div>
  </body>
</html>
